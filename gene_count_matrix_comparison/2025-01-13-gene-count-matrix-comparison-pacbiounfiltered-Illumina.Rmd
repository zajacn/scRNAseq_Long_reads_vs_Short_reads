---
title:  "p28443 Pacbio Illumina gene level comparison unfiltered"
author: "Natalia Zajac"
output:
  html_document: 
    highlight: pygments
    theme: sand
    code_folding: hide
    toc: yes
    toc_depth: 4
editor_options: 
  chunk_output_type: inline
---

Started on `r format(Sys.time(), "%Y-%m-%d %H:%M:%S")`

```{r setup, include=FALSE}
library(SummarizedExperiment)
library(plotly)
library(scater)
library(ezRun)
library(DT)
library(htmltools)
library(Matrix)
library(Seurat)
library(pheatmap)
library(DropletUtils)
library(cowplot)
library(tidyverse)
library(ggvenn)
library(patchwork)
library(UpSetR)
library(clusterProfiler)
library(org.Hs.eg.db)
library(BiocGenerics)
library(cowplot)
library(gridExtra)
library(ggbeeswarm)

source("functions.R")
sample_data = ezRead.table("../2024-05-22-sampleInfo.tsv")
##Load all pacbio dirs
pbDirs <- file.path(sample_data$PigeonUnfiltered, "genes_seurat/")

geneAnno <- ezRead.table("/srv/GT/reference/Homo_sapiens/GENCODE/GRCh38.p13/Annotation/Release_39-2021-12-09/Genes/SMRTLink11.1_annotation/genes_annotation_byGene.txt")
#Read in mtcontent from Hubert
mtcontent = read.csv("/srv/GT/analysis/zajacn/p28443/mito_content.csv")

##Pacbio create seurat object
seurat_pbDataList <- lapply(pbDirs, function(pbDir){
  cts <- Read10X(pbDir, gene.column = 1)
  featInfo <- ezRead.table(paste0(pbDir, "/genes.tsv"), header = FALSE, row.names = NULL) # , col_names = FALSE)
  colnames(featInfo) <- c("gene_id", "gene_name")
  featInfo <- featInfo[featInfo$gene_name %in% geneAnno[geneAnno$type == "protein_coding",]$gene_name, ]
  featInfo <- featInfo[!grepl("(?i)^MT-", featInfo$gene_name),]
  featInfo$isRiboprot <- grepl("(?i)^RPS|^RPL", featInfo$gene_name)
  geneInfo <- featInfo
  ctsGene <- averageRows(cts[featInfo$gene_id,], by = geneInfo$gene_name, func = sum) %>% 
    as.matrix() %>% as("dgCMatrix")
  fixed <- sub("-1", "", colnames(ctsGene)) %>% DNAStringSet() %>%
    reverseComplement() %>% as.character()
  colnames(ctsGene) <- fixed
  seurat_object = CreateSeuratObject(ctsGene)
  seurat_object <- PercentageFeatureSet(seurat_object, "(?i)^RPS|^RPL", col.name = "percent_ribo")
  samplename = sample_data[sample_data$PigeonUnfiltered == str_remove(pbDir, "/genes_seurat/"),]$Name
  mt = mtcontent[mtcontent$Barcode %in% colnames(seurat_object) & mtcontent$Sample == samplename,]
  seurat_object$percent_mito = setNames(mt[, c(4)], mt[, c(3)])
  return(seurat_object)
})
names(seurat_pbDataList) = sample_data$Name

##Pacbio seurat normlize and scale
pvalue_allMarkers <- 0.05
assay= "RNA"
vars.to.regress <- NULL

n = 1
seurat_pbDataList_norm = NULL
for (scData in seurat_pbDataList){
    v = names(seurat_pbDataList)[n]
    scData <- NormalizeData(scData, normalization.method = "LogNormalize", scale.factor=10000, verbose=FALSE)
    scData <- FindVariableFeatures(scData, selection.method = "vst", nfeatures = 3000)
    scData <- ScaleData(scData, verbose = FALSE, do.scale=FALSE)
    scData <- SCTransform(scData, vst.flavor="v2", seed.use = 38, vars.to.regress = vars.to.regress, assay = assay, verbose = FALSE, return.only.var.genes=FALSE)
    scData <- RunPCA(scData, npcs =30, verbose = FALSE)
    scData <- RunUMAP(scData, reduction = "pca", dims = 1:30)
    scData <- RunTSNE(scData, reduction = "pca", dims = 1:30)
    scData <- FindNeighbors(scData, reduction = "pca", dims = 1:30)
    scData <- FindClusters(scData, resolution = seq(from = 0.2, to = 1, by = 0.2), verbose=FALSE)
    scData$Sample <- v
    scData$Condition <- scData$Sample
    scData <- RenameCells(scData, new.names = str_remove(colnames(scData), "-1"))
    scData$sample_seurat_clusters <- paste0(scData$Sample, "-", sprintf("%02d", scData$seurat_clusters))
    seurat_pbDataList_norm[[v]] <- scData
    n = n + 1
}

illDirs <- file.path("/srv/gstore/projects", sample_data$CellRangerNoIntron, "filtered_feature_bc_matrix/")

## Create a seurat object Illumina
seurat_IllDataList <- lapply(illDirs, function(crDir){
  cts_Illumina <- Read10X(crDir, gene.column = 1)
  featInfo <- ezRead.table(paste0(crDir, "/features.tsv.gz"), header = FALSE, row.names = NULL) # , col_names = FALSE)
  colnames(featInfo) <- c("gene_id", "gene_name", "type")
  featInfo <- featInfo[featInfo$gene_name %in% geneAnno[geneAnno$type == "protein_coding",]$gene_name, ]
  featInfo <- featInfo[!grepl("(?i)^MT-", featInfo$gene_name),]
  featInfo$isRiboprot <- grepl("(?i)^RPS|^RPL", featInfo$gene_name)
  geneInfoCr <- featInfo
  ctsGeneCr <- averageRows(cts_Illumina[featInfo$gene_id,], by = geneInfoCr$gene_name, func = sum) %>% as.matrix() %>% 
    as("dgCMatrix")
  seurat_object_Illumina =  CreateSeuratObject(ctsGeneCr)
  seurat_object_Illumina <- PercentageFeatureSet(seurat_object_Illumina, "(?i)^RPS|^RPL", col.name = "percent_ribo")
  colnames(seurat_object_Illumina) = sapply(str_split(colnames(seurat_object_Illumina), "-"), .subset, 1)
  samplename = sample_data[sample_data$CellRangerNoIntron == str_remove(str_remove(crDir, "/srv/gstore/projects/"), "/filtered_feature_bc_matrix/"),]$Name
  mt = mtcontent[mtcontent$Barcode %in% colnames(seurat_object_Illumina) & mtcontent$Sample == samplename,]
  seurat_object_Illumina$percent_mito = setNames(mt[, c(5)], mt[, c(3)])
  return(seurat_object_Illumina)
})

names(seurat_IllDataList) = names(seurat_pbDataList)
## Illumina normalize and scale
n = 1
seurat_IllDataList_norm_all = NULL
for (scData in seurat_IllDataList){
    v = names(seurat_IllDataList)[n]
    scData <- NormalizeData(scData, normalization.method = "LogNormalize", scale.factor=10000, verbose=FALSE)
    scData <- FindVariableFeatures(scData, selection.method = "vst", nfeatures = 3000)
    scData <- ScaleData(scData, verbose = FALSE, do.scale=FALSE)
    scData <- SCTransform(scData, vst.flavor="v2", seed.use = 38, vars.to.regress = vars.to.regress, assay = assay, verbose = FALSE, return.only.var.genes=FALSE)
    scData <- RunPCA(scData, npcs =30, verbose = FALSE)
    scData <- RunUMAP(scData, reduction = "pca", dims = 1:30)
    scData <- RunTSNE(scData, reduction = "pca", dims = 1:30)
    scData <- FindNeighbors(scData, reduction = "pca", dims = 1:30)
    scData <- FindClusters(scData, resolution = seq(from = 0.2, to = 1, by = 0.2), verbose=FALSE)
    scData$Sample <- v
    scData$Condition <- scData$Sample
    scData <- RenameCells(scData, new.names = paste0(scData$Sample, "-", colnames(scData)))
    scData$sample_seurat_clusters <- paste0(scData$Sample, "-", sprintf("%02d", scData$seurat_clusters))
    seurat_IllDataList_norm_all[[v]] <- scData
    n = n + 1
}


#Read in cell annotations from TÃ¼lay
cellAnnot <- read.delim("/srv/GT/analysis/zajacn/p28443/ccRCC_CellType.tsv")
cellAnnot$CellBarcode <- reverseComplement(DNAStringSet(str_remove(cellAnnot$CellBarcode, "-1"))) %>% as.character()
cellAnnot = rbind(cellAnnot, data.frame("CellType" = "non-ccRCC", "CellBarcode" = "CTATCCGGTCACCTTC", "Sample" = "ccRCC_4"))
cellAnnot = rbind(cellAnnot, data.frame("CellType" = rep("non-ccRCC", length(colnames(seurat_pbDataList$ccRCC_3))), "CellBarcode" = colnames(seurat_pbDataList$ccRCC_3), "Sample" = rep("ccRCC_3", length(colnames(seurat_pbDataList$ccRCC_3)))))
cellAnnot = rbind(cellAnnot, data.frame("CellType" = rep("non-ccRCC", length(colnames(seurat_pbDataList$Normal))), "CellBarcode" = colnames(seurat_pbDataList$Normal), "Sample" = rep("Normal", length(colnames(seurat_pbDataList$Normal)))))


##Merge based on common cells and protein coding genes
pvalue_allMarkers <- 0.05
assay= "RNA"
vars.to.regress <- NULL

merged_data = NULL
for (i in names(seurat_pbDataList)){
  cellAnnotX = cellAnnot[cellAnnot$Sample == i,]
  commonIds = intersect(colnames(seurat_IllDataList[[i]]), colnames(seurat_pbDataList[[i]]))
  
  scDataIll = seurat_IllDataList[[i]][, commonIds]
  scDataIll = scDataIll[!grepl("(?i)^MT-", rownames(scDataIll) ),]
  scDataIll@meta.data$annotation = cellAnnotX[match(colnames(scDataIll), cellAnnotX$CellBarcode),]$CellType
  scDataIll <- NormalizeData(scDataIll, normalization.method = "LogNormalize", scale.factor=10000, verbose=FALSE)
  scDataIll <- FindVariableFeatures(scDataIll, selection.method = "vst", nfeatures = 3000)
  scDataIll <- ScaleData(scDataIll, verbose = FALSE, do.scale=FALSE)
  scDataIll <- SCTransform(scDataIll, vst.flavor="v2", seed.use = 38, vars.to.regress = vars.to.regress, assay = assay, verbose = FALSE, return.only.var.genes=FALSE)
  scDataIll <- RunPCA(scDataIll, npcs =30, verbose = FALSE)
  scDataIll <- RunUMAP(scDataIll, reduction = "pca", dims = 1:30)
  scDataIll <- RunTSNE(scDataIll, reduction = "pca", dims = 1:30)
  scDataIll <- FindNeighbors(scDataIll, reduction = "pca", dims = 1:30)
  scDataIll <- FindClusters(scDataIll, resolution = 0.55, verbose=FALSE)
  scDataIll$Sample <- i
  scDataIll$Condition <- scDataIll$Sample
  scDataIll$sample_seurat_clusters <- paste0(scDataIll$Sample, "-", sprintf("%02d", scDataIll$seurat_clusters))
  scDataIll$Batch = "Illumina"
  
  scDataPB = seurat_pbDataList[[i]][, commonIds]
  scDataPB = scDataPB[!grepl("(?i)^MT-", rownames(scDataPB) ),]
  scDataPB@meta.data$annotation = cellAnnotX[match(colnames(scDataPB), cellAnnotX$CellBarcode),]$CellType
  scDataPB <- NormalizeData(scDataPB, normalization.method = "LogNormalize", scale.factor=10000, verbose=FALSE)
  scDataPB <- FindVariableFeatures(scDataPB, selection.method = "vst", nfeatures = 3000)
  scDataPB <- ScaleData(scDataPB, verbose = FALSE, do.scale=FALSE)
  scDataPB <- SCTransform(scDataPB, vst.flavor="v2", seed.use = 38, vars.to.regress = vars.to.regress, assay = assay, verbose = FALSE, return.only.var.genes=FALSE)
  scDataPB <- RunPCA(scDataPB, npcs =30, verbose = FALSE)
  scDataPB <- RunUMAP(scDataPB, reduction = "pca", dims = 1:30)
  scDataPB <- RunTSNE(scDataPB, reduction = "pca", dims = 1:30)
  scDataPB <- FindNeighbors(scDataPB, reduction = "pca", dims = 1:30)
  scDataPB <- FindClusters(scDataPB, resolution = 0.55, verbose=FALSE)
  scDataPB$Sample <- i
  scDataPB$Condition <- scDataPB$Sample
  scDataPB$sample_seurat_clusters <- paste0(scDataPB$Sample, "-", sprintf("%02d", scDataPB$seurat_clusters))
  scDataPB$Batch = "PacBio"
  
  scDatalist = list("Illumina" = scDataIll, "PacBio" = scDataPB)
  scData = merge(x=scDataIll, y=scDataPB, merge.data=TRUE)
  VariableFeatures(scData) <- unlist(lapply(scDatalist, VariableFeatures))
  scData <- RunPCA(object=scData, npcs = 30, verbose=FALSE)
  scData <- RunTSNE(object = scData, reduction = "pca", dims = 1:30)
  scData <- RunUMAP(object=scData, reduction = "pca", dims = 1:30)
  scData <- FindNeighbors(object = scData, reduction = "pca", dims = 1:30, verbose=FALSE)
  scData <- FindClusters(object=scData, resolution = 0.55, verbose=FALSE)
  scData <- PrepSCTFindMarkers(scData)
  markers <- FindAllMarkers(object=scData, test.use = "wilcox", only.pos=TRUE)
  markers <- markers[ ,c("gene","cluster","pct.1", "pct.2", "avg_log2FC","p_val_adj")]
  markers$cluster <- as.factor(markers$cluster)
  markers$diff_pct = abs(markers$pct.1-markers$pct.2)
  markers <- markers[order(markers$diff_pct, decreasing = TRUE),]
  merged_data[[i]] = scData
}
```

# {.tabset}

## General {.tabset}

### Gene expression per cell in Illumina

```{r}
sumdf = NULL
for (i in names(seurat_IllDataList)){
  x = as.data.frame(seurat_IllDataList[[i]]@meta.data)[,c("nCount_RNA", "nFeature_RNA")]
  x$Sample = i
  x$Method = "Illumina"
  x = x %>% rownames_to_column()
  sumdf = rbind(sumdf, x)
}

for (i in names(seurat_pbDataList)){
  x = as.data.frame(seurat_pbDataList[[i]]@meta.data)[,c("nCount_RNA", "nFeature_RNA")]
  x$Sample = i
  x$Method = "PacBio"
  x = x %>% rownames_to_column()
  sumdf = rbind(sumdf, x)
}
sumdf = sumdf %>% rename("CellID" = "rowname")

sumdf_shared = NULL
for (i in unique(sumdf$Sample)){
  commonIds = intersect(sumdf[(sumdf$Sample == i) & (sumdf$Method == "PacBio"),]$CellID, sumdf[(sumdf$Sample == i) & (sumdf$Method == "Illumina"),]$CellID)
  x = sumdf[(sumdf$Sample == i) & (sumdf$Method == "Illumina"),] 
  x = x %>% mutate(Category=if_else(x$CellID %in% commonIds, "Common", "Illumina specific"))
  sumdf_shared = rbind(sumdf_shared, x)
}

sumdf_shared$Sample = factor(sumdf_shared$Sample, levels = c("Normal", "ccRCC_2", "ccRCC_3", "ccRCC_4", "ccRCC_5"))

p1 = ggplot(sumdf_shared, aes(nCount_RNA, nFeature_RNA, color = Category, shape = Sample)) + 
  geom_point() + 
  xlab("UMI count") + 
  ylab("Number of expressed genes") + 
  scale_shape_manual(values = c(1,2,3,4,5,6,7,8)) + 
  scale_color_manual(values = myColors) + 
  labs(shape = "Sample") + 
  theme(text = element_text(size = 15))
p1
```
### Pseudobulk correlation all cells

```{r, fig.width=7, fig.height=18, echo=FALSE, message=FALSE, warning=FALSE}

geneAnno$seurat_name <- gsub("_", "-", geneAnno$gene_name)

pacbio_pseudobulk <- lapply(seurat_pbDataList, function(x){
    rowSums(x[["RNA"]]$counts)
})

illumina_pseudobulk <- lapply(seurat_IllDataList, function(scData){
  rowSums(scData[["RNA"]]$counts)
})

pdf("Figures_2025_RevisionsNAR/Pseudobulk_gene_expression_allcells.pdf", width=7, height=18)
op = par(mfrow=c(5,2), mar = c(3,4.5,2,2))
final_toCounts_all = NULL
for (i in names(illumina_pseudobulk)){
  x = illumina_pseudobulk[[i]]
  totCounts <- data.frame("Illumina" = x)
  xm = data.frame("PacBio" = pacbio_pseudobulk[[i]])
  totCounts = merge(xm, totCounts, by = "row.names", all = TRUE)
  totCounts[is.na(totCounts)] <- 0
  totCounts = totCounts %>% column_to_rownames("Row.names")
  geneAnnoX = geneAnno[match(rownames(totCounts), geneAnno$seurat_name),]
  gcTypes = data.frame("GC < 0.4"=as.numeric(geneAnnoX$gc) < 0.4,
                         "GC > 0.6"=as.numeric(geneAnnoX$gc) > 0.6,
                         check.names=FALSE)
  widthTypes = data.frame("width < 800nt"=as.numeric(geneAnnoX$featWidth) < 800, 
                        "width >4000nt"=as.numeric(geneAnnoX$featWidth) > 4000,
                        check.names=FALSE)
  sf <- ezLogmeanScalingFactor(totCounts, presentFlag = totCounts >0)
  xNorm <- ezScaleColumns(totCounts, sf)
  ezXYScatter(xNorm[ , "Illumina"]+10, xNorm[ ,  "PacBio"]+ 10, xlab = "Illumina", ylab = "PacBio", types = gcTypes, main = i, cex = 1, cex.lab = 2)
  x = cor.test(xNorm[ , "Illumina"]+10, xNorm[ ,  "PacBio"]+ 10,  method = "pearson")
  legend(x='topleft', legend=paste('R=', round(x$estimate,4)), cex = 1.8)
  ezXYScatter(xNorm[ , "Illumina"]+10, xNorm[ ,  "PacBio"]+ 10, xlab = "Illumina", ylab = "PacBio", types = widthTypes, main = i, cex = 1, cex.lab =2)
  legend(x='topleft', legend=paste('R=', round(x$estimate,4)), cex = 1.8)
  xNorm = xNorm %>% rownames_to_column()
  xNorm = xNorm %>% mutate( if_else(xNorm[,2] > 0, 1, 0), if_else(xNorm[,3] > 0, 1, 0))
  xNorm = xNorm[,c(1,4,5)]
  colnames(xNorm) = c("Gene", paste0("Illumina", "_", i), paste0("PacBio", "_", i))
  final_toCounts_all[[i]] = xNorm[!duplicated(xNorm$Gene),]
}
par(op)
dev.off()
```

### Overlap in the detected genes common cells

```{r, fig.width=7, fig.height=4, echo=FALSE, message=FALSE, warning=FALSE}
shareddf = NULL
for (i in names(final_toCounts_all)){
  final_toCounts_all[[i]]$Category = case_when(final_toCounts_all[[i]][,2] == 1 & final_toCounts_all[[i]][,3] == 1 ~ "Common",
                                           final_toCounts_all[[i]][,2] == 1 & final_toCounts_all[[i]][,3] == 0 ~ "Illumina",
                                           final_toCounts_all[[i]][,2] == 0 & final_toCounts_all[[i]][,3] == 1 ~ "PacBio" ,
                                           final_toCounts_all[[i]][,2] == 0 & final_toCounts_all[[i]][,3] == 0 ~"Absent")
  x = final_toCounts_all[[i]] %>% group_by(Category) %>% summarise(count = n())
  x$Sample = i
  shareddf = rbind(shareddf, x)
}
shareddf$Sample = factor(shareddf$Sample, levels = unique(shareddf$Sample))
shareddf = shareddf[shareddf$Category != "Absent",]
shareddf = shareddf %>% pivot_wider(names_from = Category, values_from = count) %>% mutate(Illumina = Illumina + Common, PacBio = PacBio + Common)
shareddf$Percentage = round((shareddf$Common * 100) / shareddf$Illumina, 2)


ggplot() + 
  geom_bar(data = melt(shareddf[c(1,3,4)]), aes(Sample, value, fill = variable), position = "dodge", stat = "identity", show.legend = TRUE) + 
  geom_bar(data=melt(shareddf[c(1,2)]), stat="identity", aes(Sample, value, fill = variable), show.legend = TRUE) +
  scale_fill_manual(name = "", values = myColors, labels=c("Illumina","PacBio","Common")) +
  labs(y = "Number of Genes") +
  geom_text(data = melt(shareddf[c(1,2,5)], id.vars = c("Percentage", "Sample")), aes(Sample, value - 400, label = paste0(Percentage, "%")), color="white", size=3.5)
```


### Pseudobulk correlation common cells only 

```{r, fig.width=7, fig.height=18, echo=FALSE, message=FALSE, warning=FALSE}

geneAnno$seurat_name <- gsub("_", "-", geneAnno$gene_name)

pacbio_pseudobulk_c = NULL
for (i in names(seurat_pbDataList)){
  commonCells = intersect(colnames(seurat_IllDataList[[i]][["RNA"]]$counts),colnames(seurat_pbDataList[[i]][["RNA"]]$counts))
  scData = seurat_pbDataList[[i]][["RNA"]]$counts[,commonCells]
  pacbio_pseudobulk_c[[i]] = rowSums(scData)
}

illumina_pseudobulk_c = NULL
for (i in names(seurat_IllDataList)){
  commonCells = intersect(colnames(seurat_IllDataList[[i]][["RNA"]]$counts),colnames(seurat_pbDataList[[i]][["RNA"]]$counts))
  scData = seurat_IllDataList[[i]][["RNA"]]$counts[,commonCells]
  illumina_pseudobulk_c[[i]] = rowSums(scData)
}

pdf("Figures_2025_RevisionsNAR/Pseudobulk_gene_expression_commonCells.pdf", width=7, height=18)
op = par(mfrow=c(5,2), mar = c(3,4.5,2,2))
final_toCounts = NULL
n = 1
for (i in names(illumina_pseudobulk_c)){
  x = illumina_pseudobulk_c[[i]]
  totCounts <- data.frame("Illumina" = x)
  xm = data.frame("PacBio" = pacbio_pseudobulk_c[[i]])
  totCounts = merge(xm, totCounts, by = "row.names", all = TRUE)
  totCounts[is.na(totCounts)] <- 0
  totCounts = totCounts[rowSums(totCounts[,c(2,3)]) > 0, ]
  totCounts = totCounts %>% rownames_to_column() %>% column_to_rownames("Row.names") %>% dplyr::select(-1)
  geneAnnoX = geneAnno[match(rownames(totCounts), geneAnno$seurat_name),]
  gcTypes = data.frame("GC < 0.4"=as.numeric(geneAnnoX$gc) < 0.4,
                         "GC > 0.6"=as.numeric(geneAnnoX$gc) > 0.6,
                         check.names=FALSE)
  widthTypes = data.frame("width < 800nt"=as.numeric(geneAnnoX$featWidth) < 800, 
                        "width >4000nt"=as.numeric(geneAnnoX$featWidth) > 4000,
                        check.names=FALSE)
  sf <- ezLogmeanScalingFactor(totCounts, presentFlag = totCounts >0)
  xNorm <- ezScaleColumns(totCounts, sf)
  ezXYScatter(xNorm[ , "Illumina"]+10, xNorm[ ,  "PacBio"]+ 10, xlab = "Normalized Log-Mean Illumina", ylab = "Normalized Log-Mean PacBio", types = gcTypes, main = i, cex = 1, cex.lab = 2, cex.main = 2)
  x = cor.test(xNorm[ , "Illumina"]+10, xNorm[ ,  "PacBio"]+ 10,  method = "pearson")
  legend(x='topleft', legend=paste('R=', round(x$estimate,4)), cex = 1.8)
  ezXYScatter(xNorm[ , "Illumina"]+10, xNorm[ ,  "PacBio"]+ 10, xlab = "Normalized Log-Mean Illumina", ylab = "Normalized Log-Mean PacBio", types = widthTypes, main = i, cex = 1, cex.lab =2, cex.main = 2)
  legend(x='topleft', legend=paste('R=', round(x$estimate,4)), cex = 1.8)
  xNorm = xNorm %>% rownames_to_column()
  colnames(xNorm) = c("Gene", "PacBio", "Illumina")
  xNorm = xNorm %>% mutate( if_else(xNorm[,2] > 0, 1, 0), if_else(xNorm[,3] > 0, 1, 0))
  xNorm = xNorm[,c(1,5,4)]
  colnames(xNorm) = c("Gene", paste0("Illumina", "_", i), paste0("PacBio", "_", i))
  final_toCounts[[i]] = xNorm[!duplicated(xNorm$Gene),]
  n = n + 1
}
par(op)
dev.off()
```

### Overlap in the detected genes common cells {.tabset}

#### Upset

```{r, fig.width=10, fig.height=6, echo=FALSE, message=FALSE, warning=FALSE}
library(ComplexHeatmap)
shareddf = reduce(final_toCounts, full_join, by = "Gene")
selected_intersections = list(
  c(colnames(shareddf)[-1]),
  c(colnames(shareddf)[c(-1,-2,-3)]),
  c("PacBio_Normal", "Illumina_Normal"),
  c("PacBio_ccRCC_2", "Illumina_ccRCC_2"),
  c("PacBio_ccRCC_3", "Illumina_ccRCC_3"),
  c("PacBio_ccRCC_4", "Illumina_ccRCC_4"),
  c("PacBio_ccRCC_5", "Illumina_ccRCC_5"),
  "Illumina_Normal",
  "PacBio_Normal",
  "PacBio_ccRCC_2",
  "Illumina_ccRCC_2",
  "PacBio_ccRCC_3",
  "Illumina_ccRCC_3",
  "PacBio_ccRCC_4",
  "Illumina_ccRCC_4",
  "PacBio_ccRCC_5",
  "Illumina_ccRCC_5"
)

upset(
    shareddf,
    intersections = selected_intersections, keep.order =  T, sets = colnames(shareddf)[-1])
```

#### Venn

```{r, fig.width=10, fig.height=8, echo=FALSE, message=FALSE, warning=FALSE}
shared = NULL
for (i in names(final_toCounts)){
  sublist = NULL
  sublist[["Illumina"]] = final_toCounts[[i]][final_toCounts[[i]][,2] == 1,]$Gene
  sublist[["PacBio"]] = final_toCounts[[i]][final_toCounts[[i]][,3] == 1,]$Gene
  shared[[i]] = sublist
}

create_venn <- function(sample_data, sample_name) {
  venn_plot <- ggvenn(
    sample_data,
  auto_scale = TRUE) + ggtitle(sample_name) +
    scale_fill_manual(values = myColors)
  return(venn_plot)
}

venn_plots <- list()

for (sample_name in names(shared)) {
  venn_plots[[sample_name]] <- create_venn(shared[[sample_name]], sample_name)
}
wrap_plots(venn_plots, ncol = 3)
```

####  Common genes bar graph

```{r, fig.width=6, fig.height=5, echo=FALSE, message=FALSE, warning=FALSE}
shareddf = NULL
for (i in names(final_toCounts)){
  final_toCounts[[i]]$Category = case_when(final_toCounts[[i]][,2] == 1 & final_toCounts[[i]][,3] == 1 ~ "Common",
                                           final_toCounts[[i]][,2] == 1 & final_toCounts[[i]][,3] == 0 ~ "Illumina",
                                           final_toCounts[[i]][,2] == 0 & final_toCounts[[i]][,3] == 1 ~ "PacBio" ,
                                           final_toCounts[[i]][,2] == 0 & final_toCounts[[i]][,3] == 0 ~"Absent")
  x = final_toCounts[[i]] %>% group_by(Category) %>% summarise(count = n())
  x$Sample = i
  shareddf = rbind(shareddf, x)
}
shareddf$Sample = factor(shareddf$Sample, levels = unique(shareddf$Sample))
shareddf = shareddf[shareddf$Category != "Absent",]
shareddf = shareddf %>% pivot_wider(names_from = Category, values_from = count) %>% mutate(Illumina = Illumina + Common, PacBio = PacBio + Common)
shareddf$Percentage = round((shareddf$Common * 100) / ((shareddf$Illumina - shareddf$Common) + (shareddf$PacBio - shareddf$Common) + shareddf$Common), 1)

pdf("Figures_2025_RevisionsNAR/Common_genes_CommonCells.pdf", width=6, height=5)
ggplot() + 
  geom_bar(data = melt(shareddf[c(1,3,4)]), aes(Sample, value, fill = variable), position = "dodge", stat = "identity", show.legend = TRUE) + 
  geom_bar(data=melt(shareddf[c(1,2)]), stat="identity", aes(Sample, value, fill = variable), show.legend = TRUE) +
  scale_fill_manual(name = "", values = myColors, labels=c("Illumina","PacBio","Common")) +
  labs(y = "Number of Genes") +
  geom_text(data = melt(shareddf[c(1,2,5)], id.vars = c("Percentage", "Sample")), aes(Sample, value - 400, label = paste0(Percentage, "%")), color="white", size=3.5) + theme(legend.position = "top", legend.text = element_text(size = 13), axis.text.y = element_text(size = 16), axis.title.y = element_text(size = 16), axis.text.x = element_text(size = 14))
dev.off()
```


### Number of detected genes per cell (only common cells) 

```{r, fig.width=6, fig.height=4, echo=FALSE, message=FALSE, warning=FALSE}
geneAnno$seurat_name <- gsub("_", "-", geneAnno$gene_name)

genes = NULL
for (i in names(seurat_IllDataList)){
  df = merge(
    colSums(seurat_pbDataList[[i]]@assays$RNA$counts[rownames(seurat_pbDataList[[i]]@assays$RNA$counts) %in% geneAnno[geneAnno$type == "protein_coding",]$gene_name,] != 0) %>% data.frame() %>% rename("Pacbio" = "."),
    colSums(seurat_IllDataList[[i]]@assays$RNA$counts[rownames(seurat_IllDataList[[i]]@assays$RNA$counts) %in% geneAnno[geneAnno$type == "protein_coding",]$gene_name,] != 0) %>% data.frame() %>% rename("Illumina" = "."),
    by = "row.names"
  )
  df$Sample = i
  genes = rbind(genes, df)
}

genes$Sample = factor(genes$Sample, levels = c("Normal", "ccRCC_2", "ccRCC_3", "ccRCC_4", "ccRCC_5"))
ggplot(genes, aes(Pacbio, Illumina, color = Sample)) + geom_point() + xlim(0, 9500) + ylim(0,9500) + geom_abline() + ggtitle("Number of protein coding genes per cell") + scale_color_manual(values = myColors)
```

### Median genes per cell

```{r, fig.width=12, fig.height=5, echo=FALSE, message=FALSE, warning=FALSE}
proportions <- (1:10)/10
illumina1 = NULL
for (x in names(seurat_IllDataList)){
  pb = seurat_pbDataList[[x]]
  ill = seurat_IllDataList[[x]]
  commonIds = intersect(colnames(pb[["RNA"]]), colnames(ill[["RNA"]]))
  m <- numeric(length(proportions))
  for(i in 1:length(proportions)){
    set.seed(100)
    new.counts <- downsampleMatrix(ill[,!colnames(ill) %in% commonIds][["RNA"]]$counts, prop=proportions[i])
    m[i] <- median(Matrix::colSums(new.counts >= 1))
  }
  m <- unlist(m)
  illumina1[[x]] = m
}

illumina2 = NULL
for (x in names(seurat_IllDataList)){
  pb = seurat_pbDataList[[x]]
  ill = seurat_IllDataList[[x]]
  commonIds = intersect(colnames(pb[["RNA"]]), colnames(ill[["RNA"]]))
  m <- numeric(length(proportions))
  for(i in 1:length(proportions)){
    set.seed(100)
    new.counts <- downsampleMatrix(ill[,colnames(ill) %in% commonIds][["RNA"]]$counts, prop=proportions[i])
    m[i] <- median(Matrix::colSums(new.counts >= 1))
  }
  m <- unlist(m)
  illumina2[[x]] = m
}

n = 1
pacbio = NULL
for (x in names(seurat_pbDataList)){
  pb = seurat_pbDataList[[x]]
  ill = seurat_IllDataList[[x]]
  commonIds = intersect(colnames(pb[["RNA"]]), colnames(ill[["RNA"]]))
  m <- numeric(length(proportions))
  for(i in 1:length(proportions)){
    set.seed(100)
    new.counts <- downsampleMatrix(pb[,colnames(pb) %in% commonIds][["RNA"]]$counts, prop=proportions[i])
    m[i] <- median(Matrix::colSums(new.counts >= 1))
  }
  m <- unlist(m)
  pacbio[[x]] = m
}

df1A = melt(cbind(proportions, illumina1 %>% as_tibble()), id.vars = proportions)
df1A$Data = "Illumina specific"
df1B = melt(cbind(proportions, illumina2 %>% as_tibble()), id.vars = proportions)
df1B$Data = "Common"
df2 = melt(cbind(proportions, pacbio %>% as_tibble()), id.vars = proportions)
df2$Data = "PacBio"

df = rbind(df1A, df1B, df2)

pdf("Figures_2025_RevisionsNAR/Gene_saturationPlot.pdf", width=10, height=5)
ggplot(df %>% rename("Sample" = "variable"), aes(proportions, value, color = Data, shape = Sample)) + 
  geom_point() + 
  ylab("Median Genes per Cell") + 
  xlab("Proportion of current library size") + 
  scale_shape_manual(labels = c("Normal", "ccRCC_2", "ccRCC_3", "ccRCC_4", "ccRCC_5"), values = c(1,2,3,4,5,6,7,8)) + 
  scale_color_manual(values = myColors, labels = function(x) str_wrap(x, width = 18)) +  
  geom_line() + 
  theme(text = element_text(size = 20))
dev.off()
```

### Distribution of genes per cell

```{r, fig.width=6, fig.height=4, echo=FALSE, message=FALSE, warning=FALSE}
final = NULL
for (x in names(seurat_IllDataList)){
  pb = seurat_pbDataList[[x]]
  ill = seurat_IllDataList[[x]]
  commonIds = intersect(colnames(pb[["RNA"]]), colnames(ill[["RNA"]]))
  z = data.frame("PacBio" = colSums(pb[,colnames(pb) %in% commonIds][["RNA"]]$counts > 0))
  y = data.frame("Illumina" = colSums(ill[,colnames(ill) %in% commonIds][["RNA"]]$counts > 0))
  df = merge(z,y, by = "row.names")
  df$Sample = x
  final = rbind(final, df)
}

final$Sample = factor(final$Sample, levels = names(seurat_IllDataList))

ggplot(melt(final), aes(Sample, value, fill = variable)) + 
  geom_violin() + 
  scale_fill_manual(values = myColors) + 
  labs(x = "Sample", y = "Genes per Cell", fill = "Method") 
```


### Distribution of genes per cell

```{r, fig.width=6, fig.height=5, echo=FALSE, message=FALSE, warning=FALSE}
final = NULL
for (x in names(seurat_IllDataList)){
  pb = seurat_pbDataList[[x]]
  ill = seurat_IllDataList[[x]]
  commonIds = intersect(colnames(pb[["RNA"]]), colnames(ill[["RNA"]]))
  z = data.frame("PacBio" = colSums(pb[,colnames(pb) %in% commonIds][["RNA"]]$counts > 0)) %>% rownames_to_column("CellID") %>% melt() %>% mutate(variable = "PacBio Common")
  y = data.frame("Illumina common cells" = colSums(ill[,colnames(ill) %in% commonIds][["RNA"]]$counts > 0)) %>% rownames_to_column("CellID") %>% melt() %>% mutate(variable = "Illumina Common")
  v = data.frame("Illumina only" = colSums(ill[,!colnames(ill) %in% commonIds][["RNA"]]$counts > 0)) %>% rownames_to_column("CellID") %>% melt() %>% mutate(variable = "Illumina Only")
  df = rbind(z,y,v)
  df$Sample = x
  final = rbind(final, df)
}

final$Sample = factor(final$Sample, levels = names(seurat_IllDataList))

pdf("Figures_2025_RevisionsNAR/Gene_perCell_CommonCells.pdf", width=6, height=5)
ggplot(final, aes(Sample, value, fill = factor(variable, levels = c("Illumina Only","Illumina Common","PacBio Common")))) + 
    geom_violin() + 
    scale_fill_manual(values = c("#A6761D", "#440154FF", "cyan")) +
    labs(x = "Sample", y = "Genes per Cell", fill = "") + theme(legend.text = element_text(size = 13), legend.position = "top", axis.title.y = element_text(size = 16), axis.text.x = element_text(size = 14), axis.text.y = element_text(size = 16)) + stat_summary(fun.y=mean, geom="point", size=2, color="red", position=position_dodge(width=0.9))
dev.off()
```

## edgeR extactTest selection {.tabset}

### proportions across width/GC categories

```{r, fig.width=15, fig.height=6, echo=FALSE, message=FALSE, warning=FALSE}
library(edgeR)

final_toCounts=NULL
for (i in names(illumina_pseudobulk_c)){
  x = illumina_pseudobulk_c[[i]]
  totCounts <- data.frame("Illumina" = x)
  xm = data.frame("PacBio" = pacbio_pseudobulk_c[[i]])
  totCounts = merge(xm, totCounts, by = "row.names", all = TRUE)
  totCounts[is.na(totCounts)] <- 0
  totCounts = totCounts[rowSums(totCounts[,c(2,3)]) > 0, ]
  totCounts = totCounts %>% rownames_to_column() %>% column_to_rownames("Row.names") %>% dplyr::select(-1)
  geneAnnoX = geneAnno[match(rownames(totCounts), geneAnno$seurat_name),]
  xNorm <- totCounts
  xNorm = merge(xNorm, geneAnnoX[,c(2,10,11)], by.x = "row.names", by.y = "gene_name") %>% column_to_rownames("Row.names")
  xNorm = xNorm %>% 
    mutate(GCType = case_when(gc < 0.4 ~ "GC < 0.4", gc > 0.6 ~ "GC > 0.6", TRUE ~ "0.4<GC<0.6")) %>%
    mutate(widthType = case_when(featWidth < 800 ~ "width < 800", featWidth > 4000 ~ "width >4000", TRUE ~ "800<width<4000"))
  dge = DGEList(counts = xNorm[,c(2,1)], group = c("Illumina", "Pacbio"), genes = rownames(xNorm), remove.zeros = TRUE)
  res <- exactTest(dge, dispersion = 0.1)
  res$table$FDR = p.adjust(res$table$PValue, method="fdr")
  xNorm$EdgeRLabel = ""
  xNorm[rownames(xNorm) %in%  rownames(res$table[res$table$FDR < 0.05 & res$table$logFC > 1,]),]$EdgeRLabel = "PacBio > Illumina"
  xNorm[rownames(xNorm) %in%  rownames(res$table[res$table$FDR < 0.05 & res$table$logFC < -1,]),]$EdgeRLabel = "Illumina > PacBio"
  xNorm[xNorm$EdgeRLabel == "",]$EdgeRLabel = "Illumina ~ PacBio"
  x = xNorm
  
  p1 = rbind(x %>% 
               group_by(widthType) %>% 
               summarise(count = n()) %>% 
               mutate(EdgeRLabel = "All"), 
             x[x$Illumina > 0 & x$PacBio > 0,] %>% 
               group_by(EdgeRLabel, widthType) %>% 
               summarise(count = n())) %>% 
    ggplot(aes(EdgeRLabel, count, fill = widthType)) + 
    geom_col(position = "fill") + 
    theme(text = element_text(size = 15), axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=0.5), legend.position = 'top', legend.spacing.x = unit(0.5, 'cm')) + 
    labs(x = "")
  p1A = rbind(x %>% 
                group_by(widthType) %>% 
                summarise(count = n()) %>% 
                mutate(EdgeRLabel = "All"), x[x$Illumina > 0 & x$PacBio > 0,] %>% 
                group_by(EdgeRLabel, widthType) %>% 
                summarise(count = n())) %>% 
    ggplot(aes(EdgeRLabel, count, fill = widthType)) + 
    geom_col(position = "stack") + 
    theme(text = element_text(size = 15), axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=0.5), legend.position = 'top', legend.spacing.x = unit(0.5, 'cm')) + 
    labs(x = "")
  print(plot_grid(p1, p1A, ncol = 2))
  final_toCounts[[i]] = xNorm %>% rownames_to_column("Gene")
}

```

### width

```{r, fig.width=11, fig.height=4, echo=FALSE, message=FALSE, warning=FALSE}

comb = bind_rows(final_toCounts, .id = "Sample")
comb$Sample = factor(comb$Sample, levels = c("Normal", "ccRCC_2", "ccRCC_3", "ccRCC_4", "ccRCC_5"))
comb = comb[comb$Illumina > 0 & comb$PacBio > 0,]

merge(comb %>% group_by(Sample, EdgeRLabel, widthType) %>% summarise(count = n()), 
      comb %>% group_by(Sample, EdgeRLabel) %>% summarise(sum = n()) %>% mutate(widthType = "800<width<4000"), 
      by = c("Sample", "EdgeRLabel", "widthType"), all = TRUE) %>% 
  replace(is.na(.), "") %>% 
  ggplot(aes(EdgeRLabel, count, fill = widthType)) + 
  geom_col(position = "stack", colour="black") + 
  facet_grid(~Sample) + 
  theme(text = element_text(size = 12), axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=0.5), legend.position = 'top', legend.spacing.x = unit(0.5, 'cm')) + labs(x = "") + 
  scale_fill_manual(values = c("#F8766D", "#619CFF", "#00BA38")) + 
  geom_text(aes(x =EdgeRLabel, y = count + 600, label = sum))
```


```{r, fig.width=11, fig.height=4, echo=FALSE, message=FALSE, warning=FALSE}

merge(comb %>% group_by(Sample, EdgeRLabel, widthType) %>% summarise(count = n()), 
      comb %>% group_by(Sample, EdgeRLabel) %>% summarise(sum = n()) %>% mutate(widthType = "800<width<4000"), 
      by = c("Sample", "EdgeRLabel", "widthType"), all = TRUE) %>% 
  replace(is.na(.), "") %>% filter(!EdgeRLabel == "Illumina ~ Pacbio") %>%
  ggplot(aes(EdgeRLabel, count, fill = widthType)) + 
  geom_col(position = "stack", colour="black") + 
  facet_grid(~Sample) + 
  theme(text = element_text(size = 12), axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=0.5), legend.position = 'top', legend.spacing.x = unit(0.5, 'cm')) + labs(x = "") + 
  scale_fill_manual(values = c("#F8766D", "#619CFF", "#00BA38")) + 
  geom_text(aes(x =EdgeRLabel, y = count + 150, label = sum))
```


```{r, fig.width=11, fig.height=4, echo=FALSE, message=FALSE, warning=FALSE}

merge(comb %>% group_by(Sample, EdgeRLabel, widthType) %>% summarise(count = n()), 
      comb %>% group_by(Sample, EdgeRLabel) %>% summarise(sum = n()) %>% mutate(widthType = "800<width<4000"), 
      by = c("Sample", "EdgeRLabel", "widthType"), all = TRUE) %>% 
  replace(is.na(.), "") %>% 
  ggplot(aes(EdgeRLabel, count, fill = widthType)) + 
  geom_col(position = "fill", colour="black") + 
  facet_grid(~Sample) + 
  theme(text = element_text(size = 12), axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=0.5), legend.position = 'top', legend.spacing.x = unit(0.5, 'cm')) + labs(x = "") + 
  scale_fill_manual(values = c("#F8766D", "#619CFF", "#00BA38")) 
```


```{r, fig.width=6, fig.height=5, echo=FALSE, message=FALSE, warning=FALSE}

p1 = comb[,c(1,6,9)] %>% ggplot(aes(Sample, featWidth, fill = EdgeRLabel)) + geom_boxplot(outliers = FALSE) + scale_fill_manual(values = c("#A6761D", "#440154FF", "cyan")) + labs(y = "Gene Length", fill = "") + theme( legend.text = element_text(size = 11), legend.position = "top", legend.spacing.x = unit(3, 'cm'), text = element_text(size = 13))
p1
```

```{r,fig.width=6, fig.height=5, echo=FALSE, message=FALSE, warning=FALSE}
data_summary <- function(x) {
    m <- mean(x)
    ymin <- m-sd(x)
    ymax <- m+sd(x)
    return(c(y=m))
}

pdf("Figures_2025_RevisionsNAR/Genelength_CommonCells.pdf", width=6, height=5)
p1 = comb[,c(1,6,9)] %>% ggplot(aes(Sample, featWidth, fill = factor(EdgeRLabel, levels = c("Illumina > PacBio", "PacBio > Illumina", "Illumina ~ PacBio")))) + geom_violin() + scale_fill_manual(values = c("#A6761D","cyan","#440154FF")) + labs(y = "Gene Length (bp)", fill = "") + theme( legend.text = element_text(size = 11), legend.position = "top", legend.spacing.x = unit(3, 'cm'), text = element_text(size = 14), axis.title.y = element_text(size = 16), axis.text.y = element_text(size = 16), axis.text.x = element_text(size = 14)) + ylim(0,6000) + stat_summary(fun.y=mean, position=position_dodge(width=0.9), colour = "red")
p1
dev.off()
```

```{r, fig.width=12, fig.height=5, echo=FALSE, message=FALSE, warning=FALSE}
library(ggpubr)
my_comparisons <- list( c("Illumina > PacBio", "Illumina ~ PacBio"), c("Illumina > PacBio", "PacBio > Illumina"), c("Illumina ~ PacBio", "PacBio > Illumina") )

pdf("Figures_2025_RevisionsNAR/Supp_Figure3.pdf", width=12, height=5)
comb[,c(1,6,9)] %>% ggplot(aes(EdgeRLabel, featWidth)) + facet_grid(~Sample)  + geom_boxplot()   + stat_compare_means(comparisons = my_comparisons, method = "t.test") + theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust= 1)) + labs(y = "Gene Length")
dev.off()
```


```{r, fig.width=6, fig.height=5, echo=FALSE, message=FALSE, warning=FALSE}

p1 = comb[,c(1,5,9)] %>% ggplot(aes(Sample, gc, fill = EdgeRLabel)) + geom_boxplot() + scale_fill_manual(values = c("#A6761D", "#440154FF", "cyan")) + labs(y = "GC content", fill = "") + theme( legend.text = element_text(size = 11), legend.position = "top", legend.spacing.x = unit(3, 'cm'), text = element_text(size = 13))
p1
```

```{r, fig.width=12, fig.height=5, echo=FALSE, message=FALSE, warning=FALSE}

my_comparisons <- list( c("Illumina > PacBio", "Illumina ~ PacBio"), c("Illumina > PacBio", "PacBio > Illumina"), c("Illumina ~ PacBio", "PacBio > Illumina") )
pdf("Figures_2025_RevisionsNAR/Supp_Figure4.pdf", width=12, height=5)
comb[,c(1,5,9)] %>% ggplot(aes(EdgeRLabel, gc)) + facet_grid(~Sample)  + geom_boxplot()   + stat_compare_means(comparisons = my_comparisons, method = "t.test") + theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust= 1)) 
dev.off()
```

### GC

```{r, fig.width=11, fig.height=4, echo=FALSE, message=FALSE, warning=FALSE}

merge(comb %>% group_by(Sample, EdgeRLabel, GCType) %>% summarise(count = n()), 
      comb %>% group_by(Sample, EdgeRLabel) %>% summarise(sum = n()) %>% mutate(GCType = "0.4<GC<0.6"), 
      by = c("Sample", "EdgeRLabel", "GCType"), all = TRUE) %>% 
  replace(is.na(.), "") %>% 
  ggplot(aes(EdgeRLabel, count, fill = GCType)) + 
  geom_col(position = "stack", colour="black") + 
  facet_grid(~Sample) + 
  theme(text = element_text(size = 12), axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=0.5), legend.position = 'top', legend.spacing.x = unit(0.5, 'cm')) + labs(x = "") + 
  scale_fill_manual(values = c("#F8766D", "#619CFF", "#00BA38")) + 
  geom_text(aes(x =EdgeRLabel, y = count + 600, label = sum))
```

```{r, fig.width=11, fig.height=4, echo=FALSE, message=FALSE, warning=FALSE}

merge(comb %>% group_by(Sample, EdgeRLabel, GCType) %>% summarise(count = n()), 
      comb %>% group_by(Sample, EdgeRLabel) %>% summarise(sum = n()) %>% mutate(GCType = "0.4<GC<0.6"), 
      by = c("Sample", "EdgeRLabel", "GCType"), all = TRUE) %>% 
  replace(is.na(.), "") %>% 
  ggplot(aes(EdgeRLabel, count, fill = GCType)) + 
  geom_col(position = "fill", colour="black") + 
  facet_grid(~Sample) + 
  theme(text = element_text(size = 12), axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=0.5), legend.position = 'top', legend.spacing.x = unit(0.5, 'cm')) + labs(x = "") + 
  scale_fill_manual(values = c("#F8766D", "#619CFF", "#00BA38")) 
```

### All

```{r, fig.width=6, fig.height=3, echo=FALSE, message=FALSE, warning=FALSE}
comb %>% group_by(Sample, EdgeRLabel) %>% summarise(count = n()) %>% 
    ggplot(aes(count, EdgeRLabel, fill = Sample)) + 
    geom_col(position = "dodge", colour="black") + scale_fill_manual(values = myColors) + labs(y = "EdgeR Classification")
```


## merged data {.tabset}

### UMAPs merged data.  

```{r, fig.height=10, fig.width=25, echo=FALSE, message=FALSE, warning=FALSE}
groblist = NULL
n = 1
for (i in merged_data){
  v = names(merged_data)[n]
  p1 <- DimPlot(i, reduction =  "umap", group.by = "Batch") + ggtitle(v) + theme(text = element_text(size = 25))  + scale_color_manual(values = c("#A6761D", "cyan"))
  groblist[[v]] = p1
  #print(p1)
  n = n + 1
}

plot_grid(plotlist = groblist, ncol = 3)
```

### UMAPs merged data SCpubr with clusters

```{r, fig.height=20, fig.width=12, echo=FALSE, message=FALSE, warning=FALSE}
groblist = NULL
n = 1
for (i in merged_data){
  v = names(merged_data)[n]
  p1 = SCpubr::do_DimPlot(sample = i, group.by = "Batch", colors.use = myColors) + theme(plot.background = element_rect(color = "black"))
  p2 = SCpubr::do_BoxPlot(sample = i,feature = "nCount_RNA", split.by = "Batch", colors.use = myColors) + theme(plot.background = element_rect(color = "black"))
  p3 = SCpubr::do_BarPlot(i, group.by = "Batch", split.by = "seurat_clusters", position = "stack", colors.use = myColors) + theme(plot.background = element_rect(color = "black"))
  p4 = plot_grid(p1,p2,p3, ncol = 3)
  groblist[[v]] = p4
  n = n + 1
}

plot_grid(plotlist = groblist, ncol = 1, labels = c('Normal', 'ccRCC_2', "ccRCC_3", "ccRCC_4", "ccRCC_5"))
```

```{r, fig.height=15, fig.width=7, echo=FALSE, message=FALSE, warning=FALSE}
groblist = NULL
n = 1
for (i in merged_data){
  v = names(merged_data)[n]
  p1 = SCpubr::do_DimPlot(sample = i, group.by = "Batch", colors.use = myColors) + theme(plot.background = element_rect(color = "black"))
  p2 = SCpubr::do_BoxPlot(sample = i,feature = "nCount_RNA", split.by = "Batch", colors.use = myColors) + theme(plot.background = element_rect(color = "black"))
  p3 = SCpubr::do_BarPlot(i, group.by = "Batch", split.by = "seurat_clusters", position = "stack", colors.use = myColors) + theme(plot.background = element_rect(color = "black"))
  p4 = plot_grid(p1,p3, nrow = 2)
  groblist[[v]] = p4
  n = n + 1
}
pdf("Figures_2025_RevisionsNAR/UMAP_Plots_CommonCells_v2.pdf", height=15, width=7)
plot_grid(plotlist = groblist, ncol = 5, labels = c('Normal', 'ccRCC_2', "ccRCC_3", "ccRCC_4", "ccRCC_5"))
dev.off()
```

### DEGs per cluster

```{r, fig.height=10, fig.width=15, echo=FALSE, message=FALSE, warning=FALSE}

for (i in merged_data){
  Seurat::Idents(i) <- i$seurat_clusters
  de_genes <- tibble::tibble(Seurat::FindAllMarkers(object = i))
  p1 <- SCpubr::do_GroupwiseDEPlot(sample = i,
                                de_genes = de_genes,
                                min.cutoff = 1,
                                group.by = "Batch",
                                font.size = 20, axis.text.x.angle = 90)
  print(p1)
}

```

### Feature plots SCpubr

```{r, fig.height=5, fig.width=10, echo=FALSE, message=FALSE, warning=FALSE}

for (i in merged_data){
  print(SCpubr::do_FeaturePlot(sample = i,
                       features = "nFeature_RNA", split.by = "Batch"))
}

```

### Box plots SCpubr

```{r, fig.height=4, fig.width=10, echo=FALSE, message=FALSE, warning=FALSE}
groblist = NULL
n = 1
for (i in merged_data){
  v = names(merged_data)[n]
  print(SCpubr::do_BoxPlot(sample = i,feature = "nCount_RNA", split.by = "Batch"))
}

```


## Euclidean distance

```{r, fig.height=4, fig.width=10}
euclideandist = NULL
for (i in names(merged_data)){
    dist <- merge(data.frame(Embeddings(object = merged_data[[i]][["umap"]])), merged_data[[i]]@meta.data[,c("Sample","Condition","Batch")], by = "row.names") %>% mutate(CellID = sapply(str_split(Row.names, "_"), .subset, 1))
    df<-data.frame(distance = numeric())
    for (x in unique(dist[dist$Batch == "PacBio",]$CellID)){
        value = sqrt(sum((dist[(dist$CellID == x) & (dist$Batch == "PacBio"),c("umap_1", "umap_2")] - dist[(dist$CellID == x) & (dist$Batch == "Illumina"),c("umap_1", "umap_2")])^2))
        df[x,] <- value
    }
    df = df %>% arrange(desc(distance)) %>% rownames_to_column()
    df$Sample = i
    euclideandist = rbind(euclideandist, df)
}

euclideandist$Sample = factor(euclideandist$Sample, levels = c(unique(euclideandist$Sample)))
ggplot(euclideandist, aes(distance, colour = Sample)) + geom_freqpoly(binwidth = 0.1) + xlab("Euclidean distance") + theme(text = element_text(size = 20))
```


```{r, fig.height=3, fig.width=5}
pdf("Figures_2025_RevisionsNAR/Euclidean_distance_UMAP.pdf", height=3, width=5)
ggplot(euclideandist, aes(Sample, distance)) + geom_violin() + xlab("Sample") + ylab("Euclidean distance") + theme(text = element_text(size = 10)) + geom_quasirandom()
```

## Important markers expression heatmap

```{r markers1b, fig.width=8, fig.height=10, echo=FALSE, message=FALSE, warning=FALSE}
scData = merge(x=merged_data[[1]], y=tail(merged_data, length(merged_data) - 1), merge.data=TRUE)
scData = AddMetaData(scData, data.frame("Sample" = scData$Sample) %>% mutate("Sample_name" = str_remove(str_remove(scData$Sample, "_o31598"), "_1")), col.name = "Sample_name")
pdf("Figures_2025_RevisionsNAR/ccRCC_related_gene_exp_scpubr.pdf", width=8, height=10)
SCpubr::do_ExpressionHeatmap(sample = scData,
                             features = c('CA9', 'NDUFA4L2', 'ANGPTL4','EPCAM', "HILPDA4", "CRYAB", "VEGFA", "ADM", "EGLN3", "CSRP2"),
                             group.by = c( "Batch", "annotation", "Sample_name"))
dev.off()

```


## Important genes boxplot

```{r markers1b, fig.width=8, fig.height=6, echo=FALSE, message=FALSE, warning=FALSE}

ill = NULL
for (i in seq(1,5,1)){
  name = paste0("data.1.",i)
  print(name)
  ill = rbind(ill,data.frame(t(scData[["RNA"]][name][c('CA9', 'NDUFA4L2', 'ANGPTL4','EPCAM', "CRYAB", "VEGFA", "ADM", "EGLN3", "CSRP2"),])) %>% mutate(method = "Illumina") %>% mutate(sample = i))
}

pb = NULL
for (i in seq(2,5,1)){
  name = paste0("data.2.",i)
  print(name)
  pb = rbind(pb,data.frame(t(scData[["RNA"]][name][c('CA9', 'NDUFA4L2', 'ANGPTL4','EPCAM', "CRYAB", "VEGFA", "ADM", "EGLN3", "CSRP2"),])) %>% mutate(method = "PacBio") %>% mutate(sample = i))
  }
pb = rbind(pb,data.frame(t(scData[["RNA"]]["data.2.1"][c('NDUFA4L2', 'ANGPTL4','EPCAM', "CRYAB", "VEGFA", "ADM", "EGLN3", "CSRP2"),])) %>% mutate(method = "PacBio", CA9 = 0, sample = 1))

df = rbind(ill, pb) %>% group_by(sample,method) %>% summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE))) %>% mutate(sample_label = paste0(sample, "_", method)) %>% ungroup() %>% column_to_rownames("sample_label") %>% dplyr::select(-1,-2) %>% t()

annot = rbind(ill, pb) %>% group_by(sample,method) %>% summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE))) %>% mutate(sample_label = paste0(sample, "_", method)) %>% ungroup() %>% column_to_rownames("sample_label") %>% dplyr::select(1,2) %>% mutate(sample = case_when(sample == 1 ~ "Normal", sample == 2 ~ "ccRCC_2", sample == 3 ~ "ccRCC_3", sample == 4 ~ "ccRCC_4",sample == 5 ~ "ccRCC_5"))
annot$sample = factor(annot$sample, levels = sample_data$Name)

pdf("Figures_2025_RevisionsNAR/ccRCC_related_gene_exp.pdf", width=8, height=6)
pheatmap(df, show_colnames = F, annotation_col = annot, cluster_cols = F, annotation_colors = list(method = c("Illumina" = "#A6761D", "PacBio" = "cyan"), sample = c("Normal" = "#7570B3", "ccRCC_2" = "#1B9E77" , "ccRCC_3"="#D95F02","ccRCC_4"= "#E7298A" ,"ccRCC_5" = "#66A61E")), main = "Gene Expression", name = "LogNorm")
dev.off()
```